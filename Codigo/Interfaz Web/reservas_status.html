<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estado Reservas | Hotel AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f3f4f6; }
        .sidebar { min-height: 100vh; background-color: #1e293b; color: white; }
        .sidebar a { color: #94a3b8; text-decoration: none; padding: 12px; display: block; border-radius: 8px; margin-bottom: 4px;}
        .sidebar a.active, .sidebar a:hover { background-color: #334155; color: white; }
        
        .card-stat { transition: transform 0.2s; border: none; }
        .card-stat:hover { transform: translateY(-5px); }
        .icon-box { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-size: 1.5rem; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        
        <div class="col-md-2 sidebar p-3 d-none d-md-block">
            <h4 class="mb-4 text-white"><i class="bi bi-robot"></i> Dashboard API</h4>
             <nav>
                <a href="index.html"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a>
                <a href="datos.html"><i class="bi bi-table me-2"></i> Consultar datos</a>
                <a href="paises.html"><i class="bi bi-globe-americas me-2"></i> Países</a>
                <a href="tipos_hotel.html"><i class="bi bi-buildings me-2"></i> Tipos Hoteles</a>
                <a href="reservas_status.html"class="active"><i class="bi bi-pie-chart-fill me-2"></i> Estado Reservas</a>
                <a href="estadisticas.html"><i class="bi bi-bar-chart-line me-2"></i> Estadísticas</a>
                <a href="crear_reserva.html"><i class="bi bi-calendar-plus me-2"></i> Crear Reserva</a>
                <a href="actualizar_reserva.html"><i class="bi bi-pencil-square me-2"></i> Actualizar Reserva</a>
                <a href="borrar_reserva.html"><i class="bi bi-trash3 me-2"></i> Borrar Reserva</a>
                <a href="prediccion.html"><i class="bi bi-magic me-2"></i> Predicción ADR</a>
                <a href="historial.html" ><i class="bi bi-clock-history me-2"></i> Historial IA</a>
            </nav>
        </div>

        <main class="col-md-10 ms-sm-auto px-md-4 py-4">
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Distribución de Estados</h2>
                <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise me-1"></i> Refrescar
                </button>
            </div>

            <div id="loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Cargando datos del servidor...</p>
            </div>

            <div id="contentArea" style="display: none;">
                
                <div class="row g-4 mb-4">
                    <div class="col-md-4">
                        <div class="card card-stat shadow-sm h-100">
                            <div class="card-body d-flex align-items-center">
                                <div class="icon-box bg-success bg-opacity-10 text-success me-3">
                                    <i class="bi bi-check-lg"></i>
                                </div>
                                <div>
                                    <h6 class="text-uppercase text-muted small mb-1">Completadas (Check-Out)</h6>
                                    <h3 class="fw-bold mb-0" id="countCheckout">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card card-stat shadow-sm h-100">
                            <div class="card-body d-flex align-items-center">
                                <div class="icon-box bg-danger bg-opacity-10 text-danger me-3">
                                    <i class="bi bi-x-lg"></i>
                                </div>
                                <div>
                                    <h6 class="text-uppercase text-muted small mb-1">Canceladas</h6>
                                    <h3 class="fw-bold mb-0" id="countCanceled">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card card-stat shadow-sm h-100">
                            <div class="card-body d-flex align-items-center">
                                <div class="icon-box bg-warning bg-opacity-10 text-warning me-3">
                                    <i class="bi bi-eye-slash-fill"></i>
                                </div>
                                <div>
                                    <h6 class="text-uppercase text-muted small mb-1">No-Show (Ausencias)</h6>
                                    <h3 class="fw-bold mb-0" id="countNoShow">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-8">
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-white py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Gráfico de Distribución</h6>
                            </div>
                            <div class="card-body">
                                <div style="height: 350px; position: relative;">
                                    <canvas id="statusChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="card shadow-sm border-0 h-100">
                            <div class="card-header bg-white py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Detalles</h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small">
                                    Este gráfico muestra la proporción actual de estados en tu base de datos.
                                </p>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span><i class="bi bi-circle-fill text-success small me-2"></i>Check-Out</span>
                                        <span class="badge bg-success rounded-pill" id="badgeCheckout">0%</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span><i class="bi bi-circle-fill text-danger small me-2"></i>Canceled</span>
                                        <span class="badge bg-danger rounded-pill" id="badgeCanceled">0%</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span><i class="bi bi-circle-fill text-warning small me-2"></i>No-Show</span>
                                        <span class="badge bg-warning text-dark rounded-pill" id="badgeNoShow">0%</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div id="errorMsg" class="alert alert-danger mt-4" style="display: none;">
                <i class="bi bi-exclamation-triangle-fill me-2"></i> 
                No se pudo conectar con la API. Asegúrate de que <code>main.py</code> se está ejecutando.
            </div>

        </main>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // 1. Fetch al endpoint definido en tu main.py
            const response = await fetch('http://127.0.0.1:8000/reservas_status/');
            
            if (!response.ok) throw new Error("Error de conexión");
            
            const data = await response.json();
            
            // Estructura esperada: {"reservation_status_count": {"Check-Out": 10, "Canceled": 5, ...}}
            const stats = data.reservation_status_count;

            // Extraer valores con seguridad (ponemos 0 si no existe la clave)
            const checkout = stats['Check-Out'] || 0;
            const canceled = stats['Canceled'] || 0;
            const noshow = stats['No-Show'] || 0;
            const total = checkout + canceled + noshow;

            // 2. Actualizar Tarjetas
            document.getElementById('countCheckout').innerText = checkout.toLocaleString();
            document.getElementById('countCanceled').innerText = canceled.toLocaleString();
            document.getElementById('countNoShow').innerText = noshow.toLocaleString();

            // 3. Actualizar Badges (Porcentajes)
            if (total > 0) {
                document.getElementById('badgeCheckout').innerText = Math.round((checkout/total)*100) + "%";
                document.getElementById('badgeCanceled').innerText = Math.round((canceled/total)*100) + "%";
                document.getElementById('badgeNoShow').innerText = Math.round((noshow/total)*100) + "%";
            }

            // 4. Renderizar Gráfico (Chart.js)
            const ctx = document.getElementById('statusChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Check-Out (Completadas)', 'Canceled (Canceladas)', 'No-Show (Ausencias)'],
                    datasets: [{
                        data: [checkout, canceled, noshow],
                        backgroundColor: ['#198754', '#dc3545', '#ffc107'], // Verde, Rojo, Amarillo
                        hoverBackgroundColor: ['#157347', '#bb2d3b', '#e0a800'],
                        borderWidth: 0
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Mostrar contenido
            document.getElementById('loading').style.display = 'none';
            document.getElementById('contentArea').style.display = 'block';

        } catch (error) {
            console.error(error);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('errorMsg').style.display = 'block';
        }
    });
</script>

</body>
</html>